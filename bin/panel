#!/bin/bash
#
# lemonbar config by jastronaut
## features: clock, date, volume level, battery (with color indicator), current song, and workspace status
#

# get config
. ~/bin/panel_config

launcher() { # click icon to invoke rofi
	echo -e "%{F$LABEL} ${ICON_LAUNCH} %{F-}"
}

getClock() { # time
    date '+%H:%M'
}

getDate() { # date
	date '+%a %b %d'
	echo "$date"
}

getVolume() { # get volume level from alsa thing
	VOLUME=$(amixer get Master | grep % | sed -n 1p | awk -F '[' '{print $2}' | awk -F ']' '{print $1}')

	if [ $VOLUME = '0%' ];
		then echo -e " %{F$LABEL}$ICON_MUTED   MUTED %{F-}"
	else
		echo -e "%{F$LABEL}VOL  $ICON_VOLUME_HI%{F-}    $VOLUME"
	fi
}

getBattery() { # battery percentage
	BAT=$(acpi -b | grep -P -o '[0-9]+(?=%)')
	CH_STATE=$(acpi -b | cut -c12-19)
	CH=""
	if [ $CH_STATE = 'Charging' ]
		then CH='\uf0e7'
	else
		CH=""
	fi

	if [ $BAT -eq 100 ]
		then echo -e "%{F$LABEL}BAT   \uf240%{F-} %{F$YELLOW}    $BAT%%{F-}  %{F$YELLOW}$CH%{F-}"
	elif [ $BAT -le 90 ] && [ $BAT -gt 39 ]
	   then echo -e "%{F$LABEL}BAT   \uf241%{F-} %{F$GREEN}  $BAT%%{F-}  %{F$YELLOW}$CH%{F-}"
	elif [ $BAT -lt 30 ] && [ $BAT -gt 19 ]
		then echo -e "%{F$LABEL}BAT   \uf242%{F-} %{F$ORANGE}   $BAT%%{F-}  %{F$YELLOW}$CH%{F-}"
	elif [ $BAT -lt 20 ] && [ $BAT -gt 0 ]
		then echo -e "%{F$LABEL}BAT   \uf243%{F-} %{F$RED}  $BAT%%{F-}  %{F$YELLOW}$CH%{F-}"
	else
		echo -e "%{F$LABEL}BAT%{F-} %{F$GREEN}$CH  $BAT%%{F-}"
	fi
}

mpd() { # based on neeasade's function
    cur_song="$(basename "$(mpc current -f "%artist% - %title%")" | cut -c1-50 )"

    if [ -z "$cur_song" ];
    	then echo "Stopped"
    else
        paused=$(mpc | grep paused)
        [ -z "$paused" ] && toggle="${AC}mpc pause${AB}pause${AE}" ||
            toggle="${AC}mpc play${AB}play${AE}"
        prev="${AC}mpc prev${AB}${ICO_PREV}${AE}"
        next="${AC}mpc next${AB}${ICO_NEXT}${AE}"
        echo "$cur_song $prev $toggle $next"
    fi
}

desk() { # get active workspace
	CUR=$(xprop -root _NET_CURRENT_DESKTOP | awk '{print $3}')
	case $CUR in
		0) echo -e "%{U$RED}%{+u}${AC}$moveto I${AB} $WS1 ${AE}%{-u}     ${AC}$moveto II${AB} $WS2 ${AE}     ${AC}$moveto III${AB} $WS3 ${AE}";;
		1) echo -e "${AC}$moveto I${AB} $WS1 ${AE}     %{U$RED}%{+u}${AC}$moveto II${AB} $WS2 ${AE}%{-u}     ${AC}$moveto III${AB} $WS3 ${AE}";;
		2) echo -e "${AC}$moveto I${AB} $WS1 ${AE}     ${AC}$moveto II${AB} $WS2 ${AE}     %{U$RED}%{+u}${AC}$moveto III${AB} $WS3 ${AE}%{-u}";;
		*) echo "$CUR"
	esac
}

# print out the stuff in the grossest manner possible
while :; do

    echo -e "%{l}$SEP$(launcher)$SEP$(desk)$SEP$(mpd)%{c}$(getClock)$SEP $(getDate)%{r}$(getVolume) $SEP$(getBattery)$SEP"
    sleep 1

done | lemonbar -g ${PW}x${PH}+${PX}+${PY} -f "$PANEL_FONT" -f "$PANEL_FONT2" -u 4px -F "$FG" -B "$BG" -p | bash